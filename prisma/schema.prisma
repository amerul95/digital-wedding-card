generator client {
  provider   = "prisma-client-js"
  output     = "../lib/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Seed script configuration
// Run with: pnpm prisma:seed

model Session {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  token     String   @unique
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model PasswordReset {
  id         String   @id @default(uuid())
  userId     String   @map("user_id")
  resetToken String   @unique @map("reset_token")
  expiresAt  DateTime @map("expires_at")
  used       Boolean  @default(false)
  createdAt  DateTime @default(now()) @map("created_at")
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model User {
  id              String          @id @default(uuid())
  email           String          @unique
  password        String
  roleId          Int?            // Keep for backward compatibility during migration
  createdAt       DateTime        @default(now())
  designer        Designer?
  passwordsResets PasswordReset[]
  sessions        Session[]
  role            Role?           @relation("UserPrimaryRole", fields: [roleId], references: [id]) // Keep for backward compatibility
  roles           UserRole[]      // Many-to-many relationship for multiple roles
  weddings        Wedding[]
  cart            Cart[]
}

model Role {
  id    Int        @id @default(autoincrement())
  name  String     @unique
  users User[]     @relation("UserPrimaryRole") // Keep for backward compatibility
  userRoles UserRole[] // Many-to-many relationship
}

model UserRole {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  roleId    Int      @map("role_id")
  createdAt DateTime @default(now()) @map("created_at")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  role      Role     @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([userId, roleId])
  @@map("user_roles")
}

model Wedding {
  id                String         @id @default(uuid())
  userId            String
  slug              String         @unique
  groomName         String
  brideName         String
  eventDate         DateTime
  venueName         String?
  venueAddress      String?
  googleMapLink     String?
  invitationMessage String?
  coverImageUrl     String?
  themeId           String?
  songId            String?
  createdAt         DateTime       @default(now())
  isExpired         Boolean        @default(false)
  donations         Donation[]
  galleryImages     GalleryImage[]
  rsvps             Rsvp[]
  song              Song?          @relation(fields: [songId], references: [id])
  theme             Theme?         @relation(fields: [themeId], references: [id])
  user              User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  cart              Cart[]
}

model Theme {
  id              String      @id @default(uuid())
  name            String
  customId        String?     @unique @map("custom_id")
  themeName       String?     @map("theme_name")
  color           String?
  runningNumber   Int?        @map("running_number")
  primaryColor    String?
  secondaryColor  String?
  fontFamily      String?
  previewImageUrl String?
  createdAt       DateTime    @default(now())
  configJson      String?     @map("config_json")
  designerId      String?     @map("designer_id")
  isPublished     Boolean     @default(false) @map("is_published")
  updatedAt       DateTime    @updatedAt
  designer        Designer?   @relation(fields: [designerId], references: [id])
  sales           ThemeSale[]
  weddings        Wedding[]
  products        Product[]
  
  @@index([designerId, themeName])
  @@index([designerId, runningNumber])
}

model Song {
  id        String    @id @default(uuid())
  title     String?
  fileUrl   String
  createdAt DateTime  @default(now())
  weddings  Wedding[]
  products  Product[]
}

model Rsvp {
  id         String   @id @default(uuid())
  weddingId  String
  guestName  String
  guestPhone String?
  guestEmail String?
  attendance String?
  message    String?
  createdAt  DateTime @default(now())
  wedding    Wedding  @relation(fields: [weddingId], references: [id], onDelete: Cascade)
}

model Donation {
  id             String        @id @default(uuid())
  weddingId      String
  transferTypeId Int?
  qrImageUrl     String?
  bankName       String?
  accountNumber  String?
  accountHolder  String?
  note           String?
  createdAt      DateTime      @default(now())
  transferType   TransferType? @relation(fields: [transferTypeId], references: [id])
  wedding        Wedding       @relation(fields: [weddingId], references: [id], onDelete: Cascade)
}

model TransferType {
  id        Int        @id @default(autoincrement())
  typeName  String
  donations Donation[]
}

model GalleryImage {
  id        String   @id @default(uuid())
  weddingId String
  imageUrl  String
  caption   String?
  order     Int      @default(0)
  createdAt DateTime @default(now())
  wedding   Wedding  @relation(fields: [weddingId], references: [id], onDelete: Cascade)
}

model Product {
  id          String      @id @default(uuid())
  type        ProductType
  name        String
  price       Decimal     @default(0.00)
  description String?
  imageUrl    String?
  createdAt   DateTime    @default(now())
  themeId     String?
  songId      String?
  cartItems   CartItem[]
  song        Song?       @relation(fields: [songId], references: [id])
  theme       Theme?      @relation(fields: [themeId], references: [id])

  @@map("products")
}

model Cart {
  id         String      @id @default(uuid())
  userId     String
  weddingId  String?
  status     CartStatus  @default(PENDING)
  total      Decimal     @default(0.00)
  createdAt  DateTime    @default(now())
  updatedAt  DateTime    @updatedAt
  themeSales ThemeSale[]
  items      CartItem[]
  user       User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  wedding    Wedding?    @relation(fields: [weddingId], references: [id], onDelete: Cascade)

  @@map("carts")
}

model CartItem {
  id        String   @id @default(uuid())
  cartId    String
  productId String
  quantity  Int      @default(1)
  price     Decimal  @default(0.00)
  createdAt DateTime @default(now())
  cart      Cart     @relation(fields: [cartId], references: [id], onDelete: Cascade)
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@map("cart_items")
}

model Designer {
  id                String            @id @default(uuid())
  userId            String            @unique @map("user_id")
  name              String?
  address           String?
  bio               String?
  walletBalance    Decimal           @default(0.00) @map("wallet_balance")
  bankName          String?           @map("bank_name")
  accountOwnerName  String?           @map("account_owner_name")
  accountNumber     String?           @map("account_number")
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  user              User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  themes            Theme[]
  sales             ThemeSale[]
  withdrawalRequests WithdrawalRequest[]
}

model ThemeSale {
  id              String   @id @default(uuid())
  themeId         String   @map("theme_id")
  productId       String   @map("product_id")
  cartId          String   @map("cart_id")
  salePrice       Decimal  @map("sale_price")
  designerEarning Decimal  @map("designer_earning")
  companyEarning  Decimal  @map("company_earning")
  createdAt       DateTime @default(now())
  designerId      String   @map("designer_id")
  cart            Cart     @relation(fields: [cartId], references: [id])
  designer        Designer @relation(fields: [designerId], references: [id])
  theme           Theme    @relation(fields: [themeId], references: [id])
}

enum ProductType {
  THEME
  SONG
  ADDON
}

enum CartStatus {
  PENDING
  COMPLETED
  CANCELLED
}

model WithdrawalRequest {
  id              String          @id @default(uuid())
  requestNumber   Int             @unique @default(autoincrement()) @map("request_number")
  designerId      String          @map("designer_id")
  amount          Decimal
  status          WithdrawalStatus @default(PENDING)
  approvedAmount  Decimal?         @map("approved_amount")
  createdAt       DateTime        @default(now()) @map("created_at")
  approvedAt      DateTime?       @map("approved_at")
  cancelledAt     DateTime?       @map("cancelled_at")
  designer        Designer        @relation(fields: [designerId], references: [id], onDelete: Cascade)

  @@map("withdrawal_requests")
}

enum WithdrawalStatus {
  PENDING
  APPROVED
  DECLINED
  CANCELLED
}
